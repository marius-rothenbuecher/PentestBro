using System.Collections.Generic;
using System.Text.RegularExpressions;
using Whois.NET;

namespace PentestBro.Core.Whois
{
    public class WhoisLookup
    {
        public IDictionary<string, string> cache = new Dictionary<string, string>();

        public string Whois(string host)
        {
            if (this.cache.ContainsKey(host) == false)
            {
                var raw = this.FilterMessage(WhoisClient.Query(host).Raw);
                this.cache[host] = raw;
            }

            return this.cache[host];
        }

        private string FilterMessage(string raw)
        {
            raw = Regex.Replace(raw, "^%.*", string.Empty, RegexOptions.Multiline);
            raw = Regex.Replace(raw, "^%.*", string.Empty, RegexOptions.Multiline);
            raw = Regex.Replace(raw, "^#.*", string.Empty, RegexOptions.Multiline);
            raw = Regex.Replace(raw, "^#.*", string.Empty, RegexOptions.Multiline);

            var filteredRaw = raw;

            do
            {
                raw = filteredRaw;
                filteredRaw = raw.Replace("\r\n\r\n", "\r\n");
                filteredRaw = raw.Replace("\n\n", "\n");
            } while (filteredRaw != raw);

            var firstIndexOfLf = filteredRaw.IndexOf("\n");
            var firstIndexOfCrLf = filteredRaw.IndexOf("\r\n");

            if (firstIndexOfLf == 0)
                filteredRaw = filteredRaw.Substring(1, filteredRaw.Length - 1);

            if (firstIndexOfCrLf == 0)
                filteredRaw = filteredRaw.Substring(2, filteredRaw.Length - 2);

            return filteredRaw;
        }
    }
}
